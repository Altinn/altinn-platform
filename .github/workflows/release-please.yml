on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

name: release-please

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      release_info: ${{ steps.release.outputs.releases_created && toJSON(steps.release.outputs) || '' }}
    strategy:
      fail-fast: true
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 #v4.4.0
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
  trigger-post-release-workflows:
    runs-on: ubuntu-latest
    needs:
      - release-please
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - id: trigger-post-release-workflows
        name: Trigger post release pipelines
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        if: ${{ needs.release-please.outputs.releases_created == 'true' }}
        env:
          RELEASE_INFO: ${{ needs.release-please.outputs.release_info }}
        with:
          script: |
            const release_info = JSON.parse(process.env.RELEASE_INFO);
            const paths = JSON.parse(release_info.paths_released);
            const fs = require('fs').promises;

            let postReleaseConfig;
            try {
              postReleaseConfig = JSON.parse(await fs.readFile('./release-please-post-config.json', 'utf8'));
            } catch (error) {
              console.log('No release-please-post-config.json found or invalid JSON. Skipping post-release workflows.');
              return;
            }

            const hooks = postReleaseConfig['post-release-hooks'];
            if (!hooks) {
              console.log('No post-release-hooks defined.');
              return;
            }

            for (const path of paths) {
              console.log(`Processing release for path: ${path}`);
              const releaseData = {
                tag_name: release_info[`${path}--tag_name`],
                release_url: release_info[`${path}--html_url`],
                release_sha: release_info[`${path}--sha`],
                path: path
              };

              for (const [pattern, config] of Object.entries(hooks)) {
                try {
                  if (new RegExp(pattern).test(path)) {
                    console.log(`Path ${path} matches pattern ${pattern}`);
                    if (config['dispatch-pipelines']) {
                      for (const pipeline of config['dispatch-pipelines']) {
                        const workflowId = pipeline.filename;
                        const inputs = {};
                        
                        if (pipeline.inputs) {
                          for (const [key, value] of Object.entries(pipeline.inputs)) {
                            let resolvedValue = value;
                            for (const [varName, varValue] of Object.entries(releaseData)) {
                               resolvedValue = resolvedValue.replace(new RegExp(`{{${varName}}}`, 'g'), varValue);
                            }
                            inputs[key] = resolvedValue;
                          }
                        }
                        
                        console.log(`Dispatching workflow ${workflowId} for ${path} with inputs:`, JSON.stringify(inputs));
                        await github.rest.actions.createWorkflowDispatch({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          workflow_id: workflowId,
                          ref: releaseData.tag_name,
                          inputs: inputs
                        });
                      }
                    }
                  }
                } catch (e) {
                  console.error(`Error processing pattern ${pattern} for path ${path}:`, e);
                }
              }
            }