name: "Azure Grafana Token Setup"
description: "Logs in to Azure and retrieves a Grafana access token."
inputs:
  arm_client_id:
    required: true
    description: Federated Azure Client ID.
  arm_tenant_id:
    description: Azure Tenant ID
    default: cd0026d8-283b-4a55-9bfa-d0ef4a8ba21c
  resource-id:
    description: Azure Resource ID for Grafana Enterprise app
    required: true
    default: ce34e7e5-485f-4d76-964f-b3d2b16d1e4f
runs:
  using: "composite"
  steps:
    - name: Azure login
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.arm_client_id }}
        tenant-id: ${{ inputs.arm_tenant_id }}
        allow-no-subscriptions: true

    - name: Get Azure Grafana Access Token
      shell: bash
      run: |
        token=$(az account get-access-token --resource ${{ inputs.resource-id }} --query accessToken -o tsv)
        if [ -z "$token" ]; then
          echo "Failed to retrieve Grafana Enterprise app access token" >&2
          exit 1
        fi
        echo "::add-mask::$token"
        echo "TF_VAR_grafana_access_token=$token" >> $GITHUB_ENV
